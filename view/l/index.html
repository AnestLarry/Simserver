<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simserver</title>
    <style>
        #list {
            width: 62%;
            margin: 0 auto;
        }

        ul li {
            margin: 3px 5px 0 0;
            width: 30%;
            float: left;
            display: block;
            text-align: center;
            list-style: none;
        }

        @media screen and (max-width: 600px) {
            #list {
                width: 93%;
                margin: 0 auto;
            }

            .fls li {
                width: 95%;
                float: none;
                display: inline-block;
            }
        }

        @media screen and (max-width: 800px) {
            #list {
                width: 80%;
            }

            ul li {
                width: 40%;
            }
        }

        ul {
            clear: both;
        }

        .fls li:nth-child(3n-2) {
            border: green solid 3px;
        }

        .fls li:nth-child(3n-1) {
            border: blue solid 3px;
        }

        .fls li:nth-child(3n) {
            border: red solid 3px;
        }

        ul li a {
            height: 100%;
            text-decoration: none;
            word-wrap: break-word;
            outline: none;
            color: black;
            display: block;
            padding: 3px;
            font-size: large;
        }

        ul li:hover {
            background-color: #808080;
        }

        ul li:checked {
            background-color: #808080;
        }

        .fls li a div:first-child {
            float: left;
            width: 50%;
        }

        .fls li a div:last-child {
            float: right;
            width: 50%;
        }
    </style>
</head>

<body>
<input id="url" value="/" onblur="updateData(this)"/>
<div id="list">
    <h1>Items:</h1>
    <ul>
        <li>
            <a onclick="back();">..</a>
        </li>
        <li>
            <a onclick="packFolder();">pack this folder</a>
        </li>
    </ul>
    <div style="clear: both"></div>
    <h3>Folders:</h3>
    <ul class="fls" id="folderList">
    </ul>
    <div style="clear: both"></div>
    <h3>Files:</h3>
    <ul class="fls" id="fileList">
    </ul>
</div>
<template id="t_folder">
    <li><a onclick="changePath(this)"></a></li>
</template>
<template id="t_file">
    <li><a>
            <div></div>
            <div></div>
        </a></li>
</template>
<script>
    const baseUrl = window.location.protocol + "//" + window.location.host;
    var fileListNode = document.getElementById("fileList");
    var folderListNode = document.getElementById("folderList");
    var tFolder = document.querySelector("#t_folder");
    var tFile = document.querySelector("#t_file");

    function init() {
        var url = localStorage.getItem("url");
        if (url !== "") {
            document.getElementById("url").value = url;
        } else {
            document.getElementById("url").value = "/";
        }
        updateData(document.getElementById("url"));
    }

    init();

    function updateData(u) {
        var url = baseUrl + "/api/dl/ls/" + u.value;
        var data = JSON.parse(httpGet(url));
        fileListNode.innerHTML = "";
        folderListNode.innerHTML = "";
        if (data["folderList"] !== null) {
            setTimeout(((data) => {
                data["folderList"].sort((a, b) => a.Name < b.Name ? a : b);
                data["folderList"].forEach((v, i) => {
                    var a = tFolder.content.querySelector("a");
                    a.setAttribute("target", v["Path"]);
                    a.id = v["Name"];
                    a.innerText = v["Name"];
                    folderListNode.appendChild(document.importNode(tFolder.content, true));
                });
            }), 0, data);
        }
        if (data["fileList"] !== null) {
            setTimeout(((data) => {
                data["fileList"].sort((a, b) => a.Name < b.Name ? a : b);
                data["fileList"].forEach((v, i) => {
                    var divs = tFile.content.querySelectorAll("div");
                    divs[0].innerText = v["Name"];
                    divs[1].innerText = v["Size"] + " MB";
                    var a = tFile.content.querySelector("a");
                    a.href = v["Path"];
                    fileListNode.appendChild(document.importNode(tFile.content, true));
                });
            }), 0, data);
        }
        localStorage.setItem("url", u.value)
    }

    function changePath(n) {
        document.getElementById("url").value = n.getAttribute("target");
        localStorage.setItem("prevFolder", n.innerText);
        updateData(document.getElementById("url"));
    }

    function back() {
        var url = document.getElementById("url").value;
        url.replace(/\/+$/);
        document.getElementById("url").value = url.substring(0, url.lastIndexOf("/"));
        updateData(document.getElementById("url"));
        let prevFolder = localStorage.getItem("prevFolder");
        if (prevFolder !== null) {
            window.scrollTo(0, document.getElementById(prevFolder).getBoundingClientRect().top + window.scrollY - 60);
            localStorage.removeItem("prevFolder");
        }
    }

    function packFolder() {
        window.open(baseUrl + "/api/dl/zip/" + document.getElementById("url").value, "_blank");
    }

    function httpGet(theUrl) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", theUrl, false); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }
</script>
</body>

</html>