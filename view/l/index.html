<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simserver</title>
    <style>
        #list {
            width: 62%;
            margin: 0 auto;
        }

        ul li {
            margin: 3px 5px 0 0;
            width: 30%;
            float: left;
            display: block;
            text-align: center;
            list-style: none;
        }

        @media screen and (max-width: 600px) {
            #list {
                width: 93%;
                margin: 0 auto;
            }

            .fls li {
                width: 95%;
                float: none;
                display: inline-block;
            }
        }

        @media screen and (max-width: 800px) {
            #list {
                width: 80%;
            }

            ul li {
                width: 40%;
            }
        }

        ul {
            clear: both;
        }

        .fls li:nth-child(3n-2) {
            border: green solid 3px;
        }

        .fls li:nth-child(3n-1) {
            border: blue solid 3px;
        }

        .fls li:nth-child(3n) {
            border: red solid 3px;
        }

        ul li a {
            height: 100%;
            text-decoration: none;
            word-wrap: break-word;
            outline: none;
            color: black;
            display: block;
            padding: 3px;
            font-size: large;
        }

        ul li:hover {
            background-color: #808080;
        }

        ul li:checked {
            background-color: #808080;
        }

        .fls table{
            border-collapse: collapse;
        }

        .fls table tr:nth-child(2) {
            border-top: 1px solid red;
            border-bottom: 1px solid red;
        }

        #pwd {
            border: solid red;
        }
    </style>
</head>

<body>
<input id="url" value="/" onblur="changeUrl(this)"/>
<div id="pwd"></div>
<div id="list">
    <h1>Items:</h1>
    <ul>
        <li>
            <a onclick="back();">..</a>
        </li>
        <li>
            <a onclick="packFolder();">pack this folder</a>
        </li>
        <li>sortBy <select onblur="sortedBy=this.value;localStorage.setItem('sortedBy',this.value);updateData(false)">
            <option value="NameOrder">NameOrder</option>
            <option value="NameReverse">NameReverse</option>
            <option value="TimeOrder">TimeOrder</option>
            <option value="TimeReverse">TimeReverse</option>
            </select> 
        </li>
    </ul>
    <div style="clear: both"></div>
    <h3>Folders:</h3>
    <ul class="fls" id="folderList">
    </ul>
    <div style="clear: both"></div>
    <h3>Files:</h3>
    <ul class="fls" id="fileList">
    </ul>
</div>
<template id="t_folder">
    <li><a onclick="changePath(this)"><table>
        <tr><td class="name"></td></tr>
        <tr><td></td></tr>
    </table></a></li>
</template>
<template id="t_file">
    <li><a><table>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
    </table></a></li>
</template>
<script>
    const baseUrl = window.location.protocol + "//" + window.location.host;
    var fileListNode = document.getElementById("fileList");
    var folderListNode = document.getElementById("folderList");
    var tFolder = document.querySelector("#t_folder");
    var tFile = document.querySelector("#t_file");
    var listData = "";
    var sortedBy = "NameOrder";

    function init() {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack !== null && Object.keys(urlStack).length > 0) {
            document.getElementById("url").value = urlStack.join("/");
        } else {
            document.getElementById("url").value = "/";
            localStorage.setItem("urlStack", JSON.stringify(["/"]));
        }
        if(localStorage.getItem("sortedBy")!==null){
            sortedBy = localStorage.getItem("sortedBy")
        }
        updateData(true);
    }

    init();

    function getSortFunction() {
        const funcMap = {
            "NameOrder":(a,b)=> a.Name.localeCompare(b.Name),
            "NameReverse":(a,b)=> -a.Name.localeCompare(b.Name),
            "TimeOrder":(a,b)=> (new Date(a.ModTime)) - (new Date(b.ModTime)),
            "TimeReverse":(a,b)=> (new Date(b.ModTime)) - (new Date(a.ModTime)),
        }
        return funcMap[sortedBy]
    }

    function updateData(requestOnce) {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if(requestOnce){
            var url = "";
            if (urlStack.length > 1) {
                url = baseUrl + "/api/dl/ls/" + urlStack.join("/");
            } else {
                url = baseUrl + "/api/dl/ls/" + urlStack[0];
            }
            listData = JSON.parse(httpGet(url));
        }
        fileListNode.innerHTML = "";
        folderListNode.innerHTML = "";
        if (urlStack.length > 1) {
            document.getElementById("pwd").innerText = urlStack.join("/");
        } else {
            document.getElementById("pwd").innerText = urlStack[0];
        }
        if (listData["folderList"] !== null) {
            listData["folderList"].sort(getSortFunction());
            listData["folderList"].forEach((v, i) => {
                const modtime = new Date(v["ModTime"]);
                var tds = tFolder.content.querySelectorAll("td");
                var a = tFolder.content.querySelector("a");
                a.setAttribute("target", v["Path"]);
                a.id = v["Name"];
                tds[0].innerHTML = v["Name"];
                tds[1].innerHTML = `${modtime.getFullYear()}-${modtime.getMonth()}-${modtime.getDate()} ${modtime.getHours()}:${modtime.getMinutes()}:${modtime.getSeconds()}`;
                folderListNode.appendChild(document.importNode(tFolder.content, true));
            });
        }
        if (listData["fileList"] !== null) {
            listData["fileList"].sort(getSortFunction());
            listData["fileList"].forEach((v, i) => {
                const modtime = new Date(v["ModTime"]);
                var tds = tFile.content.querySelectorAll("td");
                tds[0].innerHTML = v["Name"];
                tds[1].innerHTML = `${modtime.getFullYear()}-${modtime.getMonth()}-${modtime.getDate()} ${modtime.getHours()}:${modtime.getMinutes()}:${modtime.getSeconds()}`;
                tds[2].innerHTML = v["Size"] + " MB";
                var a = tFile.content.querySelector("a");
                if (urlStack.length === 1 && urlStack[0] === "/") {
                    a.href = baseUrl + "/api/dl/n//" + v["Name"];
                } else {
                    a.href = baseUrl + "/api/dl/n/" + urlStack.join("/") + "/" + v["Name"];
                }
                fileListNode.appendChild(document.importNode(tFile.content, true));
            });
        }
    }

    function changePath(n) {
        const folderName = n.getElementsByClassName("name")[0].innerText;
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack.length === 1 && urlStack[0] === "/") {
            urlStack.push(urlStack.pop() + folderName);
        } else if (urlStack.length > 1 || urlStack[0] !== "/") {
            urlStack.push(folderName);
        } else {
            urlStack = ["/"];
        }
        localStorage.setItem("urlStack", JSON.stringify(urlStack));
        localStorage.setItem("prevFolder", folderName);
        updateData(true);
    }

    function changeUrl(n) {
        var url = n.value.substring(n.value.indexOf("/") + 1);
        var urlStack = url.split("/");
        if (n.value[0] === "/") {
            urlStack[0] = "/" + urlStack[0];
        }
        localStorage.setItem("urlStack", JSON.stringify(urlStack));
        console.log(url);
        console.log(urlStack);
        updateData(true);
    }

    function back() {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack.length > 1) {
            urlStack.pop();
        } else {
            urlStack[0] = "/";
        }
        localStorage.setItem("urlStack", JSON.stringify(urlStack));
        updateData(true);
        let prevFolder = document.getElementById(localStorage.getItem("prevFolder"));
        if (prevFolder !== null) {
            window.scrollTo(0, prevFolder.getBoundingClientRect().top + window.scrollY - 60);
            localStorage.removeItem("prevFolder");
        }
    }

    function packFolder() {
        window.open(baseUrl + "/api/dl/zip/" + document.getElementById("url").value, "_blank");
    }

    function httpGet(theUrl) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", theUrl, false); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }
</script>
</body>

</html>