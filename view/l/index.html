<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simserver</title>
    <style>
        #list {
            width: 62%;
            margin: 0 auto;
        }

        ul li {
            margin: 3px 5px 0 0;
            width: 30%;
            float: left;
            display: block;
            text-align: center;
            list-style: none;
        }

        @media screen and (max-width: 600px) {
            #list {
                width: 93%;
                margin: 0 auto;
            }

            .fls li {
                width: 95%;
                float: none;
                display: inline-block;
            }
        }

        @media screen and (max-width: 800px) {
            #list {
                width: 80%;
            }

            ul li {
                width: 40%;
            }
        }

        ul {
            clear: both;
        }

        .fls li:nth-child(3n-2) {
            border: green solid 3px;
        }

        .fls li:nth-child(3n-1) {
            border: blue solid 3px;
        }

        .fls li:nth-child(3n) {
            border: red solid 3px;
        }

        ul li a {
            height: 100%;
            text-decoration: none;
            word-wrap: break-word;
            outline: none;
            color: black;
            display: block;
            padding: 3px;
            font-size: large;
        }

        ul li:hover {
            background-color: #808080;
        }

        ul li:checked {
            background-color: #808080;
        }

        .fls li a div:first-child {
            float: left;
            width: 50%;
        }

        .fls li a div:last-child {
            float: right;
            width: 50%;
        }

        #pwd {
            border: solid red;
        }
    </style>
</head>

<body>
<input id="url" value="/" onblur="changeUrl(this)"/>
<div id="pwd"></div>
<div id="list">
    <h1>Items:</h1>
    <ul>
        <li>
            <a onclick="back();">..</a>
        </li>
        <li>
            <a onclick="packFolder();">pack this folder</a>
        </li>
    </ul>
    <div style="clear: both"></div>
    <h3>Folders:</h3>
    <ul class="fls" id="folderList">
    </ul>
    <div style="clear: both"></div>
    <h3>Files:</h3>
    <ul class="fls" id="fileList">
    </ul>
</div>
<template id="t_folder">
    <li><a onclick="changePath(this)"></a></li>
</template>
<template id="t_file">
    <li><a>
            <div></div>
            <div></div>
        </a></li>
</template>
<script>
    const baseUrl = window.location.protocol + "//" + window.location.host;
    var fileListNode = document.getElementById("fileList");
    var folderListNode = document.getElementById("folderList");
    var tFolder = document.querySelector("#t_folder");
    var tFile = document.querySelector("#t_file");

    function init() {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack !== null && Object.keys(urlStack).length > 0) {
            document.getElementById("url").value = urlStack.join("/");
        } else {
            document.getElementById("url").value = "/";
            localStorage.setItem("urlStack", JSON.stringify(["/"]));
        }
        updateData();
    }

    init();

    function updateData() {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        var url = "";
        if (urlStack.length > 1) {
            url = baseUrl + "/api/dl/ls/" + urlStack.join("/");
        } else {
            url = baseUrl + "/api/dl/ls/" + urlStack[0];
        }
        var data = JSON.parse(httpGet(url));
        fileListNode.innerHTML = "";
        folderListNode.innerHTML = "";
        if (urlStack.length > 1) {
            document.getElementById("pwd").innerText = urlStack.join("/")
        } else {
            document.getElementById("pwd").innerText = urlStack[0];
        }
        if (data["folderList"] !== null) {
            data["folderList"].sort((a, b) => a.Name < b.Name ? a : b);
            data["folderList"].forEach((v, i) => {
                var a = tFolder.content.querySelector("a");
                a.setAttribute("target", v["Path"]);
                a.id = v["Name"];
                a.innerText = v["Name"];
                folderListNode.appendChild(document.importNode(tFolder.content, true));
            });
        }
        if (data["fileList"] !== null) {
            data["fileList"].sort((a, b) => a.Name < b.Name ? a : b);
            data["fileList"].forEach((v, i) => {
                var divs = tFile.content.querySelectorAll("div");
                divs[0].innerText = v["Name"];
                divs[1].innerText = v["Size"] + " MB";
                var a = tFile.content.querySelector("a");
                a.href = v["Path"];
                fileListNode.appendChild(document.importNode(tFile.content, true));
            });
        }
    }

    function changePath(n) {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack.length === 1 && urlStack[0] === "/") {
            urlStack.push(urlStack.pop() + n.innerText);
        } else if (urlStack.length > 1 || urlStack[0] !== "/") {
            urlStack.push(n.innerText);
        } else {
            urlStack = ["/"];
        }
        localStorage.setItem("urlStack", JSON.stringify(urlStack))
        localStorage.setItem("prevFolder", n.innerText);
        updateData();
    }

    function changeUrl(n) {
        var url = n.value.substring(n.value.indexOf("/") + 1);
        var urlStack = [n.value.substring(0, n.value.indexOf("/") + 1)].push(...url.split("/"));
        localStorage.setItem("urlStack", JSON.stringify(urlStack));
        updateData();
    }

    function back() {
        var urlStack = JSON.parse(localStorage.getItem("urlStack"));
        if (urlStack.length > 1) {
            urlStack.pop();
        } else {
            urlStack[0] = "/";
        }
        localStorage.setItem("urlStack", JSON.stringify(urlStack));
        updateData();
        let prevFolder = document.getElementById(localStorage.getItem("prevFolder"));
        console.log(prevFolder !== null);
        if (prevFolder !== null) {
            window.scrollTo(0, prevFolder.getBoundingClientRect().top + window.scrollY - 60);
            localStorage.removeItem("prevFolder");
        }
    }

    function packFolder() {
        window.open(baseUrl + "/api/dl/zip/" + document.getElementById("url").value, "_blank");
    }

    function httpGet(theUrl) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", theUrl, false); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }
</script>
</body>

</html>